<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FUD Arena Survivor - Enhanced</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/6.5.9/browser/pixi.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pixi-sound@3.0.5/dist/pixi-sound.js"></script>
    <style>
        body {
            font-family: 'Press Start 2P', cursive;
            background: linear-gradient(45deg, #1a1a1a, #2a2a2a);
            color: #ffffff;
            overflow: hidden;
            touch-action: none;
        }
        canvas {
            cursor: none;
            display: block;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.3);
        }
        .ui-element {
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.7), rgba(50, 50, 50, 0.5));
            padding: 8px 16px;
            border-radius: 8px;
            border: 2px solid #444;
            text-shadow: 2px 2px 4px #000;
            backdrop-filter: blur(5px);
        }
        #xpBar {
            width: 100%;
            height: 24px;
            background: linear-gradient(90deg, #333, #555);
            border-radius: 12px;
            overflow: hidden;
            border: 2px solid #666;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.5);
        }
        #xpFill {
            width: 0%;
            height: 100%;
            background: linear-gradient(90deg, #33ff33, #66ff66);
            transition: width 0.3s ease;
            box-shadow: 0 0 10px rgba(51, 255, 51, 0.5);
        }
        #levelUpModal, #gameOverScreen, #startScreen, #pauseScreen {
            background: linear-gradient(135deg, rgba(20, 20, 20, 0.95), rgba(40, 40, 40, 0.9));
            border: 4px solid #666;
            border-radius: 16px;
            backdrop-filter: blur(10px);
        }
        .upgrade-btn, .action-btn {
            background: linear-gradient(135deg, #3a3a3a, #2a2a2a);
            border: 2px solid #555;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            border-radius: 8px;
        }
        .upgrade-btn:hover, .action-btn:hover {
            background: linear-gradient(135deg, #4a4a4a, #3a3a3a);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.4);
            border-color: #777;
        }
        .upgrade-btn:active, .action-btn:active {
            transform: translateY(2px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .joystick-base {
            position: absolute;
            width: 120px;
            height: 120px;
            background: rgba(80, 80, 80, 0.6);
            border-radius: 50%;
            bottom: 40px;
            left: 40px;
            border: 3px solid rgba(200, 200, 200, 0.3);
        }
        .joystick-stick {
            position: absolute;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, rgba(150, 150, 150, 0.8), rgba(120, 120, 120, 0.6));
            border-radius: 50%;
            top: 30px;
            left: 30px;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }
        .combo-display {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2em;
            color: #ffff00;
            text-shadow: 2px 2px 4px #000;
            animation: comboFade 2s ease-out forwards;
            pointer-events: none;
        }
        @keyframes comboFade {
            0% { opacity: 1; transform: translate(-50%, -50%) scale(1.5); }
            100% { opacity: 0; transform: translate(-50%, -80%) scale(1); }
        }
        .settings-panel {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.8);
            padding: 10px;
            border-radius: 8px;
            border: 2px solid #444;
        }
        .volume-slider {
            width: 100px;
            margin: 5px 0;
        }
        #bossWarning {
            position: absolute;
            top: 20%;
            left: 50%;
            transform: translateX(-50%);
            font-size: 3em;
            color: #ff0000;
            text-shadow: 2px 2px 4px #000;
            animation: bossWarning 3s ease-in-out;
            pointer-events: none;
        }
        @keyframes bossWarning {
            0%, 100% { opacity: 0; transform: translateX(-50%) scale(0.5); }
            50% { opacity: 1; transform: translateX(-50%) scale(1.2); }
        }
    </style>
</head>
<body class="w-screen h-screen flex items-center justify-center p-4">

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∏–≥—Ä—ã -->
    <div id="gameContainer" class="relative w-full h-full max-w-[1200px] max-h-[900px] flex items-center justify-center">
        
        <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ -->
        <div id="settingsPanel" class="settings-panel hidden">
            <div class="text-sm mb-2">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
            <div class="text-xs mb-1">–ú—É–∑—ã–∫–∞:</div>
            <input type="range" id="musicVolume" class="volume-slider" min="0" max="100" value="50">
            <div class="text-xs mb-1">–ó–≤—É–∫–∏:</div>
            <input type="range" id="sfxVolume" class="volume-slider" min="0" max="100" value="70">
            <button id="togglePause" class="action-btn text-xs px-2 py-1 mt-2">–ü–∞—É–∑–∞</button>
        </div>

        <!-- UI –ò–≥—Ä—ã -->
        <div id="gameUI" class="absolute top-0 left-0 w-full p-4 hidden">
            <div class="flex justify-between items-center gap-4">
                <div class="ui-element flex-1">
                    <div class="text-sm text-gray-300 mb-1">LVL: <span id="levelText">1</span> | –ö–æ–º–±–æ: <span id="comboText">x1</span></div>
                    <div id="xpBar"><div id="xpFill"></div></div>
                </div>
                <div class="ui-element text-center">
                    <div class="text-lg">–í–†–ï–ú–Ø</div>
                    <div class="text-3xl" id="timer">00:00</div>
                    <div class="text-sm text-gray-300" id="waveText">–í–æ–ª–Ω–∞ 1</div>
                </div>
                <div class="ui-element text-right">
                    <div class="text-lg">–í–†–ê–ì–ò</div>
                    <div class="text-3xl" id="killCount">0</div>
                    <div class="text-sm text-gray-300">–°—á—ë—Ç: <span id="scoreText">0</span></div>
                </div>
            </div>
            <button id="settingsBtn" class="absolute top-4 right-4 action-btn text-sm px-3 py-2">‚öôÔ∏è</button>
        </div>

        <!-- –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ –±–æ—Å—Å–µ -->
        <div id="bossWarning" class="hidden">‚ö†Ô∏è –ë–û–°–° –ü–†–ò–ë–õ–ò–ñ–ê–ï–¢–°–Ø! ‚ö†Ô∏è</div>

        <!-- –≠–∫—Ä–∞–Ω –ø–∞—É–∑—ã -->
        <div id="pauseScreen" class="absolute inset-0 flex-col items-center justify-center p-8 gap-6 text-center hidden">
            <h2 class="text-4xl text-yellow-400">–ü–ê–£–ó–ê</h2>
            <div class="flex gap-4">
                <button id="resumeButton" class="action-btn text-xl px-6 py-3 rounded-lg">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
                <button id="mainMenuButton" class="action-btn text-xl px-6 py-3 rounded-lg">–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</button>
            </div>
        </div>

        <!-- –≠–∫—Ä–∞–Ω "–£—Ä–æ–≤–µ–Ω—å –ø–æ–≤—ã—à–µ–Ω" -->
        <div id="levelUpModal" class="absolute inset-0 flex-col items-center justify-center p-8 gap-6 text-center hidden">
            <h2 class="text-4xl text-yellow-400">LEVEL UP!</h2>
            <p class="text-lg">–í—ã–±–µ—Ä–∏—Ç–µ —É–ª—É—á—à–µ–Ω–∏–µ:</p>
            <div id="upgradeOptions" class="w-full max-w-md flex flex-col gap-4">
                <!-- –û–ø—Ü–∏–∏ —É–ª—É—á—à–µ–Ω–∏–π –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã —Å—é–¥–∞ -->
            </div>
        </div>
        
        <!-- –°—Ç–∞—Ä—Ç–æ–≤—ã–π —ç–∫—Ä–∞–Ω -->
        <div id="startScreen" class="absolute inset-0 flex flex-col items-center justify-center p-8 gap-6 text-center">
            <div class="flex items-center gap-4">
                 <div style="width:48px; height:48px; background-color: #2b2b2b; display:flex; justify-content: center; align-items: center; position: relative; border-radius: 8px; box-shadow: 0 0 15px rgba(46, 204, 113, 0.5);">
                    <div style="width: 40px; height: 40px; background-color: white; position: absolute; border-radius: 4px;"></div>
                    <div style="width: 32px; height: 32px; background-color: #2ecc71; position: absolute; border-radius: 4px;"></div>
                </div>
                <h1 class="text-4xl md:text-5xl text-green-400">FUD Arena Survivor</h1>
            </div>
            <div class="text-lg text-yellow-300">Enhanced Edition</div>
            <p class="text-lg mt-4 max-w-xl">–õ—è–≥—É—à–∫–∞ –Ω–∞ –∫—É—Ä–∏—Ü–µ –ø—Ä–æ—Ç–∏–≤ –≤–æ–ª–Ω FUD'–∞. –í—ã–∂–∏–≤–∏ –∫–∞–∫ –º–æ–∂–Ω–æ –¥–æ–ª—å—à–µ!</p>
            <div class="mt-4">
                <p class="text-xl text-green-300">–ù–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:</p>
                <div class="text-sm mt-2 space-y-1">
                    <p>üî• –ù–æ–≤—ã–µ —Ç–∏–ø—ã –≤—Ä–∞–≥–æ–≤ –∏ –±–æ—Å—Å—ã</p>
                    <p>‚ö° –°–∏—Å—Ç–µ–º–∞ –∫–æ–º–±–æ –∏ —É–ª—É—á—à–µ–Ω–Ω—ã–µ –∞–ø–≥—Ä–µ–π–¥—ã</p>
                    <p>üí´ –í–∏–∑—É–∞–ª—å–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã –∏ —á–∞—Å—Ç–∏—Ü—ã</p>
                    <p>üéµ –£–ª—É—á—à–µ–Ω–Ω–æ–µ –∞—É–¥–∏–æ</p>
                </div>
            </div>
            <div class="mt-4">
                <p class="text-xl">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:</p>
                <p> <span class="text-yellow-400">WASD</span> / <span class="text-yellow-400">–°—Ç—Ä–µ–ª–∫–∏</span> - –¥–≤–∏–∂–µ–Ω–∏–µ</p>
                <p> <span class="text-yellow-400">ESC</span> - –ø–∞—É–∑–∞</p>
                <p class="md:hidden mt-2">–ò–ª–∏ <span class="text-yellow-400">–î–∂–æ–π—Å—Ç–∏–∫</span> –Ω–∞ —ç–∫—Ä–∞–Ω–µ</p>
            </div>
            <button id="startButton" class="action-btn text-2xl px-8 py-4 rounded-lg mt-6">–ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button>
        </div>

        <!-- –≠–∫—Ä–∞–Ω "–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞" -->
        <div id="gameOverScreen" class="absolute inset-0 flex-col items-center justify-center p-8 gap-4 text-center hidden">
            <h2 class="text-5xl text-red-500">GAME OVER</h2>
            <p class="text-2xl mt-4">–í—ã –ø—Ä–æ–¥–µ—Ä–∂–∞–ª–∏—Å—å:</p>
            <p id="finalTime" class="text-4xl text-yellow-400">00:00</p>
            <div class="grid grid-cols-2 gap-4 mt-4">
                <div>
                    <p class="text-xl">–£–Ω–∏—á—Ç–æ–∂–µ–Ω–æ FUD'–µ—Ä–æ–≤:</p>
                    <p id="finalKills" class="text-3xl text-yellow-400">0</p>
                </div>
                <div>
                    <p class="text-xl">–§–∏–Ω–∞–ª—å–Ω—ã–π —Å—á—ë—Ç:</p>
                    <p id="finalScore" class="text-3xl text-green-400">0</p>
                </div>
                <div>
                    <p class="text-xl">–î–æ—Å—Ç–∏–≥–Ω—É—Ç—ã–π —É—Ä–æ–≤–µ–Ω—å:</p>
                    <p id="finalLevel" class="text-3xl text-blue-400">1</p>
                </div>
                <div>
                    <p class="text-xl">–õ—É—á—à–µ–µ –∫–æ–º–±–æ:</p>
                    <p id="finalCombo" class="text-3xl text-purple-400">x1</p>
                </div>
            </div>
            <button id="restartButton" class="action-btn text-2xl px-8 py-4 rounded-lg mt-8">–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞</button>
        </div>

        <!-- –î–∂–æ–π—Å—Ç–∏–∫ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ -->
        <div id="joystick" class="joystick-base hidden">
            <div class="joystick-stick"></div>
        </div>
    </div>

<script>
    // --- DOM ELEMENTS ---
    const gameContainer = document.getElementById('gameContainer');
    const gameUI = document.getElementById('gameUI');
    const levelText = document.getElementById('levelText');
    const xpFill = document.getElementById('xpFill');
    const timerDisplay = document.getElementById('timer');
    const killCountDisplay = document.getElementById('killCount');
    const scoreText = document.getElementById('scoreText');
    const comboText = document.getElementById('comboText');
    const waveText = document.getElementById('waveText');
    const levelUpModal = document.getElementById('levelUpModal');
    const upgradeOptionsContainer = document.getElementById('upgradeOptions');
    const startScreen = document.getElementById('startScreen');
    const gameOverScreen = document.getElementById('gameOverScreen');
    const pauseScreen = document.getElementById('pauseScreen');
    const bossWarning = document.getElementById('bossWarning');
    const startButton = document.getElementById('startButton');
    const restartButton = document.getElementById('restartButton');
    const resumeButton = document.getElementById('resumeButton');
    const mainMenuButton = document.getElementById('mainMenuButton');
    const togglePause = document.getElementById('togglePause');
    const settingsBtn = document.getElementById('settingsBtn');
    const settingsPanel = document.getElementById('settingsPanel');
    const musicVolume = document.getElementById('musicVolume');
    const sfxVolume = document.getElementById('sfxVolume');
    const finalTime = document.getElementById('finalTime');
    const finalKills = document.getElementById('finalKills');
    const finalScore = document.getElementById('finalScore');
    const finalLevel = document.getElementById('finalLevel');
    const finalCombo = document.getElementById('finalCombo');

    // --- PIXI.JS SETUP ---
    const app = new PIXI.Application({
        resizeTo: gameContainer,
        backgroundColor: 0x1a1a1a,
        antialias: false,
    });
    gameContainer.appendChild(app.view);
    PIXI.settings.SCALE_MODE = PIXI.SCALE_MODES.NEAREST;

    // Game layers
    const worldContainer = new PIXI.Container();
    const effectsContainer = new PIXI.Container();
    const uiContainer = new PIXI.Container();
    app.stage.addChild(worldContainer);
    app.stage.addChild(effectsContainer);
    app.stage.addChild(uiContainer);

    // --- GAME VARIABLES ---
    let player, enemies, projectiles, xpOrbs, healthPacks, particles, bosses;
    let keys = {};
    let gameState = 'start'; // start, playing, levelup, gameover, paused
    let gameTime = 0;
    let killCount = 0;
    let score = 0;
    let combo = 1;
    let maxCombo = 1;
    let comboTimer = 0;
    let spawnTimer = 0;
    let healthPackSpawnTimer = 0;
    let nextHealthPackSpawnTime = 0;
    let firstHealthPackSpawned = false;
    let wave = 1;
    let bossSpawned = false;
    let musicTrack = null;

    let joystick, joystickActive = false, joystickPos = {x: 0, y: 0}, joystickDir = {x: 0, y: 0};

    // --- GAME ASSETS (USER PROVIDED WITH FALLBACKS) ---
    const textures = {
        player: PIXI.Texture.from('frog.png'), // –ï–¥–∏–Ω—ã–π —Å–ø—Ä–∞–π—Ç –∏–≥—Ä–æ–∫–∞
        paperHands: PIXI.Texture.from('bull.png'),
        bear: PIXI.Texture.from('bear.png'),
        whale: PIXI.Texture.from('whale.png'),
        boss: PIXI.Texture.from('boss.png'),
        projectile: PIXI.Texture.from('https://placehold.co/10x10/f1c40f/000000'),
        xpOrb: PIXI.Texture.from('xp.png'),
        healthPack: PIXI.Texture.from('health.png'), // –ê–ø—Ç–µ—á–∫–∞
    };
    
    // Fallback textures if user files fail to load
    const fallbackTextures = {
        whale: 'data:image/svg+xml;base64,' + btoa('<svg viewBox="0 0 48 32" xmlns="http://www.w3.org/2000/svg"><ellipse cx="24" cy="16" rx="24" ry="16" fill="#4a90e2"/><ellipse cx="24" cy="16" rx="20" ry="12" fill="#357abd"/><circle cx="16" cy="12" r="3" fill="#fff"/><circle cx="32" cy="12" r="3" fill="#fff"/><polygon points="8,16 0,8 0,24" fill="#357abd"/></svg>'),
        boss: 'data:image/svg+xml;base64,' + btoa('<svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg"><rect width="64" height="64" fill="#722f37" rx="8"/><rect x="8" y="8" width="48" height="48" fill="#8b2635" rx="4"/><circle cx="20" cy="20" r="4" fill="#ff0000"/><circle cx="44" cy="20" r="4" fill="#ff0000"/><rect x="16" y="40" width="32" height="8" fill="#000" rx="2"/><polygon points="32,8 24,0 40,0" fill="#ff6b6b"/></svg>')
    };
    
    // Error handling for missing textures
    Object.keys(textures).forEach(key => {
        if (key === 'whale' || key === 'boss') {
            textures[key].baseTexture.on('error', () => {
                if (fallbackTextures[key]) {
                    textures[key] = PIXI.Texture.from(fallbackTextures[key]);
                }
            });
        }
    });
    
    // --- SOUNDS (USER PROVIDED) ---
    const sounds = {
        shot: PIXI.sound.Sound.from('hitHurt.wav'),
        enemyDeath: PIXI.sound.Sound.from('powerUp.wav'),
        heal: PIXI.sound.Sound.from('pickupCoin.wav'),
        xp: PIXI.sound.Sound.from('key.wav'),
        levelUp: PIXI.sound.Sound.from('powerUp.wav'), // –ò—Å–ø–æ–ª—å–∑—É–µ–º powerUp –¥–ª—è levelUp
        bossWarning: PIXI.sound.Sound.from('hitHurt.wav'), // –ò—Å–ø–æ–ª—å–∑—É–µ–º hitHurt –¥–ª—è –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
        combo: PIXI.sound.Sound.from('key.wav') // –ò—Å–ø–æ–ª—å–∑—É–µ–º key –¥–ª—è –∫–æ–º–±–æ
    };

    // Set volumes
    Object.values(sounds).forEach(sound => {
        sound.volume = 0.3;
    });

    // --- ENHANCED GAME SETTINGS (REBALANCED) ---
    const playerStats = {
        speed: 3.0, maxHp: 100, hp: 100, level: 1, xp: 0, xpToNextLevel: 22,
        attackCooldown: 700, projectileSpeed: 5.5, projectileDamage: 15,
        projectileCount: 1, magnetRange: 120, critChance: 0.05, critMultiplier: 2.0,
        damageAura: { active: false, damage: 0, range: 0, cooldown: 900, lastTick: 0 },
        shield: { active: false, hp: 0, maxHp: 0, regenRate: 4, lastRegen: 0 },
        piercing: 0, homingShots: false, explosiveShots: false, freezeShots: false
    };
    
    const enhancedUpgradePool = [
        { id: 'attackSpeed', title: '–ë—ã—Å—Ç—Ä—ã–µ –Ø–π—Ü–∞', description: '–°–∫–æ—Ä–æ—Å—Ç—å –∞—Ç–∞–∫–∏ +25%', rarity: 'common', apply: () => playerStats.attackCooldown *= 0.75 },
        { id: 'damage', title: '–¢—è–∂–µ–ª—ã–µ –Ø–π—Ü–∞', description: '–£—Ä–æ–Ω +35%', rarity: 'common', apply: () => playerStats.projectileDamage *= 1.35 },
        { id: 'speed', title: '–ë—ã—Å—Ç—Ä—ã–µ –õ–∞–ø–∫–∏', description: '–°–∫–æ—Ä–æ—Å—Ç—å +20%', rarity: 'common', apply: () => playerStats.speed *= 1.2 },
        { id: 'health', title: '–¢–æ–ª—Å—Ç–∞—è –ö–æ–∂–∞', description: '–ú–∞–∫—Å. HP +25, –ª–µ—á–∏—Ç 25%', rarity: 'common', apply: () => { 
            playerStats.maxHp += 25; 
            player.hp = Math.min(playerStats.maxHp, player.hp + playerStats.maxHp * 0.25); 
        }},
        { id: 'multishot', title: '–î–≤–æ–π–Ω–æ–π –ó–∞–ª–ø', description: '–í—ã–ø—É—Å–∫–∞–µ—Ç +1 —Å–Ω–∞—Ä—è–¥', rarity: 'uncommon', apply: () => playerStats.projectileCount++ },
        { id: 'magnet', title: '–ú–∞–≥–Ω–∏—Ç –¥–ª—è –ì–µ–º–æ–≤', description: '–î–∞–ª—å–Ω–æ—Å—Ç—å —Å–±–æ—Ä–∞ –æ–ø—ã—Ç–∞ +40%', rarity: 'common', apply: () => playerStats.magnetRange *= 1.4 },
        { id: 'crit', title: '–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –£–¥–∞—Ä', description: '–®–∞–Ω—Å –∫—Ä–∏—Ç–∞ +8%, —É—Ä–æ–Ω –∫—Ä–∏—Ç–∞ +50%', rarity: 'rare', apply: () => { 
            playerStats.critChance += 0.08; 
            playerStats.critMultiplier += 0.5; 
        }},
        { id: 'aura', title: '–ê—É—Ä–∞ –°—Ç–µ–π–∫–∏–Ω–≥–∞', description: '–ù–∞–Ω–æ—Å–∏—Ç —É—Ä–æ–Ω –≤—Ä–∞–≥–∞–º –≤–æ–∫—Ä—É–≥', rarity: 'rare', apply: () => { 
            if (!playerStats.damageAura.active) {
                playerStats.damageAura.active = true;
                playerStats.damageAura.damage = 8;
                playerStats.damageAura.range = 100;
            } else {
                playerStats.damageAura.damage *= 1.6;
                playerStats.damageAura.range *= 1.3;
            }
        }},
        { id: 'shield', title: '–≠–Ω–µ—Ä–≥–µ—Ç–∏—á–µ—Å–∫–∏–π –©–∏—Ç', description: '–ü–æ–ª—É—á–∞–µ—Ç –∑–∞—â–∏—Ç–Ω—ã–π —â–∏—Ç', rarity: 'rare', apply: () => {
            if (!playerStats.shield.active) {
                playerStats.shield.active = true;
                playerStats.shield.maxHp = 50;
                playerStats.shield.hp = 50;
            } else {
                playerStats.shield.maxHp += 30;
                playerStats.shield.hp = playerStats.shield.maxHp;
            }
        }},
        { id: 'piercing', title: '–ü—Ä–æ–±–∏–≤–Ω—ã–µ –°–Ω–∞—Ä—è–¥—ã', description: '–°–Ω–∞—Ä—è–¥—ã –ø—Ä–æ–±–∏–≤–∞—é—Ç +2 –≤—Ä–∞–≥–∞', rarity: 'uncommon', apply: () => playerStats.piercing += 2 },
        { id: 'homing', title: '–ù–∞–≤–æ–¥—è—â–∏–µ—Å—è –°–Ω–∞—Ä—è–¥—ã', description: '–°–Ω–∞—Ä—è–¥—ã —Å–ª–µ–¥—É—é—Ç –∑–∞ –≤—Ä–∞–≥–∞–º–∏', rarity: 'epic', apply: () => playerStats.homingShots = true },
        { id: 'explosive', title: '–í–∑—Ä—ã–≤–Ω—ã–µ –°–Ω–∞—Ä—è–¥—ã', description: '–°–Ω–∞—Ä—è–¥—ã –≤–∑—Ä—ã–≤–∞—é—Ç—Å—è –ø—Ä–∏ –ø–æ–ø–∞–¥–∞–Ω–∏–∏', rarity: 'epic', apply: () => playerStats.explosiveShots = true },
        { id: 'freeze', title: '–ó–∞–º–æ—Ä–∞–∂–∏–≤–∞—é—â–∏–µ –°–Ω–∞—Ä—è–¥—ã', description: '–°–Ω–∞—Ä—è–¥—ã –∑–∞–º–µ–¥–ª—è—é—Ç –≤—Ä–∞–≥–æ–≤', rarity: 'rare', apply: () => playerStats.freezeShots = true },
        { id: 'comboMaster', title: '–ú–∞—Å—Ç–µ—Ä –ö–æ–º–±–æ', description: '–ö–æ–º–±–æ –¥–µ—Ä–∂–∏—Ç—Å—è –¥–æ–ª—å—à–µ, +25% –æ–ø—ã—Ç–∞', rarity: 'epic', apply: () => {
            playerStats.comboMaster = true;
        }}
    ];

    // Load game code first, then set up event listeners
    async function initializeGame() {
        try {
            // Load game classes and functions
            const response = await fetch('./game.js');
            if (response.ok) {
                const gameCode = await response.text();
                eval(gameCode);
            } else {
                throw new Error('Could not load game.js');
            }
        } catch (error) {
            console.log('Loading embedded game code...');
            // Fallback - we'll embed the code directly
        }
        
        // Now set up event listeners
        setupEventListeners();
    }

    function setupEventListeners() {
        // --- EVENT LISTENERS ---
        startButton.addEventListener('click', () => {
            if (PIXI.sound.context.state === 'suspended') {
                PIXI.sound.context.resume();
            }
            if (typeof init === 'function') {
                init();
            } else {
                console.error('init function not found');
            }
        });
        
        restartButton.addEventListener('click', () => {
            if (typeof init === 'function') {
                init();
            }
        });
        
        resumeButton.addEventListener('click', () => {
            if (typeof togglePauseGame === 'function') {
                togglePauseGame();
            } else {
                gameState = 'playing';
                pauseScreen.classList.add('hidden');
                gameUI.classList.remove('hidden');
            }
        });
        
        mainMenuButton.addEventListener('click', () => {
            gameState = 'start';
            pauseScreen.classList.add('hidden');
            gameUI.classList.add('hidden');
            startScreen.classList.remove('hidden');
        });
        
        togglePause.addEventListener('click', () => {
            if (typeof togglePauseGame === 'function') {
                togglePauseGame();
            }
        });
        
        settingsBtn.addEventListener('click', () => {
            settingsPanel.classList.toggle('hidden');
        });
        
        musicVolume.addEventListener('input', () => {
            // Music volume would be handled here
        });
        
        sfxVolume.addEventListener('input', () => {
            const volume = sfxVolume.value / 100;
            Object.values(sounds).forEach(sound => {
                sound.volume = volume * 0.3;
            });
        });

        window.addEventListener('keydown', e => {
            keys[e.key] = true;
            if (e.key === 'Escape') {
                e.preventDefault();
                if (gameState === 'playing' || gameState === 'paused') {
                    if (typeof togglePauseGame === 'function') {
                        togglePauseGame();
                    }
                }
            }
        });
        
        window.addEventListener('keyup', e => keys[e.key] = false);

        if (typeof isMobile === 'function' && isMobile()) {
            if (typeof setupJoystick === 'function') {
                setupJoystick();
            }
        }
    }

    // Initialize the game when page loads
    document.addEventListener('DOMContentLoaded', () => {
        initializeGame();
        app.ticker.add((delta) => {
            if (typeof gameLoop === 'function') {
                gameLoop(delta);
            }
        });
    });

</script>
<script src="./game.js"></script>
</body>
</html>